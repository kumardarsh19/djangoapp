<!DOCTYPE html>

<head>
    {% load static %}
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link href="{% static 'home.css' %}" rel="stylesheet" type="text/css">

    <header class="bg-primary text-white text-center py-2">
        <h1 class="display-4">Music Transcribe</h1>
    </header>

    
</head>

<body>
    {% if reject %}
        <div class="alert alert-danger" role="alert">
            The file you uploaded has too much noise and we cannot process it. Please try a different file.
        </div>
    {% endif %}
    <script src="https://unpkg.com/vexflow@4.1.0/build/cjs/vexflow-debug.js"></script>
    <div class = "container-fluid py-4">
        <form enctype="multipart/form-data" method="post">
            {% csrf_token %}
            <table>
                <div class="userValues">
                    {{form.as_p}}
                </div>
            </table>
            <input class="btn btn-primary" type="submit" value="Submit">
        </form>
    </div>

    
    <div id="test">
        {% if integrated %} {{integrated|safe}} {% endif %}
    </div>
    
    <div id="notebox" >
        {%if notes %}
            {{notes}}
        {% endif %}
    </div>
    
    {%if pitches|length > 0 %}
        <div id="boo"></div>

        <div id="musicsheet"></div>
        <script type="module">
            import { getNoteList, Note } from "{% static 'js/transcribe.js' %}"
            import { getStaves, getStaveNotes, convertToVex } from "{% static 'js/helpers.js' %}"
            
            // Start of Transcription code
            const { Renderer, Stave, Formatter, StaveNote, Beam, TickContext } = Vex.Flow;
            Renderer.DEBUG = true;
            Stave.DEBUG = true;
            Formatter.DEBUG = true;
            StaveNote.DEBUG = true;
            Beam.DEBUG = true;

            // Create an SVG renderer and attach it to the DIV element named "boo".
            const div = document.getElementById("musicsheet");
            const renderer = new Renderer(div, Renderer.Backends.SVG);
            var tickContext = new TickContext();
            var startx = 50;
            var starty = 100;

            var staveWidth = 400;
            var staveHeight = 90;

            var contextWidth = 3;
            var contextHeight = 100;

            var timeSigNum = 4;
            var timeSigDenom = 4;
            let timeSignature = {{timeSignature|safe}};
            switch (timeSignature) {
                case 1:
                    timeSignature = "4/4";
                case 0.75:
                    timeSignature = "3/4";
                case 0.5:
                    timeSignature = "2/4";
                case 0.25:
                    timeSignature = "1/4";
                case 0.752:
                    timeSignature = "6/8";
                case 0.375:
                    timeSignature = "3/8";
            }
            let clef = "treble";
            try {
                //TODO: this will not work for some reason.
                clef = {{clef}};
            } catch (e) {
                console.log("Obtaining clef error + ", e);
            }

            renderer.resize(staveWidth*contextWidth, staveHeight * contextHeight);
            var context = renderer.getContext();
            

            // Get the pitches, and onsets array.
            var pitches = {{pitches|safe}};
            var onsets = {{onsets|safe}};
            var integrated = {{integrated|safe}};
            console.log("Integrated: " + integrated);
            integrated.forEach(note => {
                console.log("key: " + note.key);
                console.log("duration: " + note.duration);
            });
            var notelist = integrated;

            var staveNotes = convertToVex(integrated, Vex);
                        

            var staveList = getStaves(startx, starty, staveWidth, staveHeight, contextWidth, contextHeight, Vex);

            staveList.forEach(stave => {
                stave.setContext(context).draw();
            });

            staveList[0].addClef(clef).addTimeSignature(timeSignature).draw();
            var totalDuration = 0;

            console.log("Notes: ", staveNotes)
            console.log("Staves: ", staveList)
            
            var firstStave = staveList[0];
            firstStave.addTimeSignature(timeSigNum + "/" + timeSigDenom);
            firstStave.addClef(clef);
            
            for (let i=0; i<staveList.length; i++) {
                let currStave = staveList[i];
                let measure = [];
                for (let j=i*4; j < (i*4 + 4) && j<staveNotes.length; j++) {
                    let currNote = staveNotes[j];
                    currNote.setStave(currStave);
                    measure.push(currNote);
                }
                console.log(measure);
                if (measure.length > 0) Formatter.FormatAndDraw(context, currStave, measure, true);
            }


            console.log(staveList);
            console.log(staveNotes);
            console.log(context);
        </script>



{% endif %}

    <script> var path = "/static/vexflow/src/vex.ts"; </script>

    <footer class="text-center text-white" style="background-color: #f1f1f1;">
        <div class="text-center text-dark p-3" style="background-color: rgba(0, 0, 0, 0.2);">
            Â© 2023 Copyright
        </div>
    </footer>
</body>