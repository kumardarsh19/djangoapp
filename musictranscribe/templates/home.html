<head>
    {% load static %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link href="{% static 'home.css' %}" rel="stylesheet" type="text/css">

    <header class="bg-primary text-white text-center py-2">
        <h1 class="display-4">Music Transcribe</h1>
    </header>
</head>

<body>
    <script src="https://unpkg.com/vexflow@4.1.0/build/cjs/vexflow-debug.js"></script>
    <div class = "container-fluid py-4">
        <form enctype="multipart/form-data" method="post">
            {% csrf_token %}
            <table>
                <div class="userValues">
                    {{form.as_p}}
                </div>
            </table>
            <input class="btn btn-primary" type="submit" value="Submit">
        </form>
    </div>

    <div id="notebox" >
        {%if notes %}
            {{notes}}
        {% endif %}
    </div>
    
    {%if pitches|length > 0 %}
        <div id="boo"></div>

        <div id="output"></div>
        <script>
            // Note class for Vex.Flow
            class Note {
                constructor(name, length) {
                    this.name = name;
                    this.length = length;
                }
            }

            const { Renderer, Stave } = Vex.Flow;

            // Create an SVG renderer and attach it to the DIV element named "boo".
            const div = document.getElementById("output");
            const renderer = new Renderer(div, Renderer.Backends.SVG);

            // Configure the rendering context.
            renderer.resize(500, 500);
            const context = renderer.getContext();

            // Create a stave of width 400 at position 10, 40 on the canvas.
            const stave = new Stave(10, 40, 400);
            
            // Get the pitches, and onsets array.
            var pitches = {{pitches|safe}};
            var onsets = {{onsets|safe}};
            var notes = getNoteList(pitches, onsets);

            // Use the clef and treble from the notes array to set in Vex.Flow
            stave.addClef("{{clef|safe}}").addTimeSignature("{{timeSignature|safe}}");

            // Connect it to the rendering context and draw!
            stave.setContext(context).draw();
            
            // getNoteList integrates the output of rhythm and pitch processor
            // into a list of notes that can be used by Vex.Flow.
            function getNoteList(pitches, onsets) {
                notes = [];
                length = pitches.length;
                duration = 1;
                for (let i = 1; i < length; i++) {
                    if (pitches[i] == pitches[i-1]) {
                        // print("increment duration")
                        duration += 1;
                    } else if (pitches[i] != pitches[i-1] && onsets[i-1] == 1) {
                        // Incorporate a regular note
                        // print("regular")
                        note = new Note(pitches[i-1], duration/8);
                        notes.push(note);
                        duration = 1;
                    } else {
                        // Incorporate a rest note
                        // print("rest")
                        note = new Note('##', duration/8);
                        notes.push(note);
                    }
                }
                // Add the last note.
                if (onsets[length-1] == 1) {
                    note = new Note(pitches[length-1], duration/8);
                    notes.push(note);
                } else {
                    note = new Note('##', duration/8);
                    notes.push(note);
                }
                return notes;
            }
        </script>
    {% endif %}

    <script>
        var path = "/static/vexflow/src/vex.ts";
    </script>
</body>