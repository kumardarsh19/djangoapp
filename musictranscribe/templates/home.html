<!DOCTYPE html>

<head>
    {% load static %}
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link href="{% static 'home.css' %}" rel="stylesheet" type="text/css">

    <header class="bg-primary text-white text-center py-2">
        <h1 class="display-4">Music Transcribe</h1>
    </header>

    <script id="helpers" src="{% static 'js/helpers.js' %}"></script>
</head>

<body>
    <script src="https://unpkg.com/vexflow@4.1.0/build/cjs/vexflow-debug.js"></script>
    <div class = "container-fluid py-4">
        <form enctype="multipart/form-data" method="post">
            {% csrf_token %}
            <table>
                <div class="userValues">
                    {{form.as_p}}
                </div>
            </table>
            <input class="btn btn-primary" type="submit" value="Submit">
        </form>
    </div>

    <div id="notebox" >
        {%if notes %}
            {{notes}}
        {% endif %}
    </div>
    
    {%if pitches|length > 0 %}
        <div id="boo"></div>

        <div id="musicsheet"></div>
        <script type="module">
            import { getNoteList } from './../static/js/transcribe.js'
            import { Note } from './../static/js/transcribe.js'
            // Start of Transcription code
            const { Renderer, Stave, Formatter, StaveNote, Beam } = Vex.Flow;

            // Create an SVG renderer and attach it to the DIV element named "boo".
            const div = document.getElementById("musicsheet");
            const renderer = new Renderer(div, Renderer.Backends.SVG);

            var staveW = 500
            var staveH = 90

            // Configure the rendering context.
            var contextWidth = staveW * 4;
            var contextHeight = staveH * 5;

            renderer.resize(contextWidth, contextHeight);
            const context = renderer.getContext();
            var startx = 50;
            var starty = 10;
            var width = 500;
            
            
            var startStave = new Stave(startx, starty, staveW);
            

            // Get the pitches, and onsets array.
            var pitches = {{pitches|safe}};
            var onsets = {{onsets|safe}};
            var notes = getNoteList(pitches, onsets);
            for (let i = 0; i < notes.length; i++) {
                console.log(notes[i].name, notes[i].length);
            }
            
            // Use the clef and treble from the notes array to set in Vex.Flow
            startStave.addClef("{{clef|safe}}").addTimeSignature("{{timeSignature|safe}}");
            startStave.setContext(context);

            const notesMeasure2_part1 = [new StaveNote({ keys: ["c/4"], duration: "8" }), new StaveNote({ keys: ["d/4"], duration: "8" }), new StaveNote({ keys: ["b/4"], duration: "8" }), new StaveNote({ keys: ["c/4", "e/4", "g/4"], duration: "8" })];

            const notesMeasure2_part2 = [new StaveNote({ keys: ["c/4"], duration: "8" }), new StaveNote({ keys: ["d/4"], duration: "8" }), new StaveNote({ keys: ["b/4"], duration: "8" }), new StaveNote({ keys: ["c/4", "e/4", "g/4"], duration: "8" })];

            // Create the beams for 8th notes in second measure.
            const beam1 = new Beam(notesMeasure2_part1);
            const beam2 = new Beam(notesMeasure2_part2);

            const notesMeasure2 = notesMeasure2_part1.concat(notesMeasure2_part2);

            var staveList = getStaves(Math.floor(notes.length), startStave);
            console.log("Notes: ", notes)
            console.log("Staves: ", staveList)
            
            for (let i=0; i<staveList.length; i++) {
                staveList[i].setContext(context).draw();
            }

            
        </script>
    {% endif %}

    <script> var path = "/static/vexflow/src/vex.ts"; </script>

    <footer class="text-center text-white" style="background-color: #f1f1f1;">
        <div class="text-center text-dark p-3" style="background-color: rgba(0, 0, 0, 0.2);">
            Â© 2023 Copyright
        </div>
    </footer>
</body>